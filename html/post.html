<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帖子页面</title>
  <link rel="stylesheet" href="../css/post.css" />
  <link rel="stylesheet" href="../css/copyright.css" />
  <link rel="stylesheet" href="../css/top1.css" />
  <link rel="stylesheet" href="../css/navbar.css" />
  <link rel="stylesheet" href="../css/foot.css" />
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="../highlight/styles/railscasts.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>

  <body tabindex="-1">
    <div class="edison-header">
      <div class="container">
        <div class="header-inner-wrap">
          <div class="logo">
            <span class="wsite-logo">
              <a href="/">
                <span id="wsite-title">TECH CODE</span>
              </a>
            </span>
          </div>
          <div class="nav-wrap">
            <div class="nav desktop-nav">
              <ul class="wsite-menu-default">
                <li id="active" class="wsite-menu-item-wrap">
                  <a href="/" class="wsite-menu-item">
                    主页
                  </a>
                </li>
                <li id="pg695107136787074782" class="wsite-menu-item-wrap has-submenu">
                  <a href="/product" class="wsite-menu-item">
                    产品
                  </a>
                  <div class="wsite-menu-wrap">
                    <ul class="wsite-menu">
                      <li id="pg695107136787074782" class="wsite-menu-subitem-wrap">
                        <a href="/product" class="wsite-menu-subitem">
                          产品
                        </a>
                      </li>
                      <li id="wsite-nav-656255702513029941" class="wsite-menu-subitem-wrap">
                        <a href="/compare" class="wsite-menu-item">
                          <span class="wsite-menu-title">
                            对比
                          </span>
                        </a>
                      </li>
                    </ul>
                  </div>
                </li>
                <li id="pg686450546927473873" class="wsite-menu-item-wrap">
                  <a href="/evaluation" class="wsite-menu-item">
                    测评
                  </a>
                </li>
                <li id="pg103030197960015510" class="wsite-menu-item-wrap">
                  <a href="/3616435759.html" class="wsite-menu-item">
                    资讯
                  </a>
                </li>
                <li id="pg881371934255644335" class="wsite-menu-item-wrap">
                  <a href="/forum" class="wsite-menu-item">
                    论坛
                  </a>
                </li>
                <li id="pg140230651504229610" class="wsite-menu-item-wrap">
                  <a href="/login_register" class="wsite-menu-item">
                    注册
                  </a>
                </li>
                <li id="pg190149529979835302" class="wsite-menu-item-wrap">
                  <a href="/login_register" class="wsite-menu-item">
                    登录
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="wsite-spacer" style="height:100px;"></div>
    <header>
      <h1>TechCode论坛</h1>
    </header>
    <div id="post-page">
      <div id="post-container">
        <div class="content">
          <div>
            <div id="post-content">
              <!-- 帖子内容在这里显示 -->
            </div>
            <div class="wsite-spacer" style="height:40px;"></div>
            <div id="comments">
              <!-- 评论内容在这里显示 -->
            </div>
            <!-- 添加回复表单 -->
            <div id="reply-form-container" style="display: none;">
              <h4>回复评论</h4>
              <form id="reply-form">
                <input type="hidden" id="parent-comment-id" value="">
                <div class="input-group">
                  <textarea class="comment-text form-control" id="comment-text" placeholder="写下你的回复..."></textarea>
                  <div class="input-group-append">
                  </div>
                </div>
                <button type="submit" class="btn btn-default mt-2"
                  style="background-color: rgb(34, 33, 33); color: rgb(246, 247, 248);font-family: 'SmileySans-Oblique';">发表回复</button>
                <button type="button" id="cancel-reply" class="btn btn-default mt-2"
                  style="background-color: rgb(34, 33, 33); color: rgb(246, 247, 248);font-family: 'SmileySans-Oblique';">取消</button>
              </form>
            </div>
            <div class="wsite-spacer" style="height:20px;"></div>
            <form id="comment-form">
              <input type="hidden" id="parent-comment-id" value="">
              <div class="input-group">
                <textarea class="comment-text form-control" id="comment-text" placeholder="写下你的评论..."></textarea>
                <div class="input-group-append">
                </div>
              </div>
              <button type="submit" class="btn btn-default mt-2"
                style="background-color: rgb(34, 33, 33); color: rgb(246, 247, 248);font-family: 'SmileySans-Oblique';">发表评论</button>
            </form>
          </div>

          <div class="sidebar">
            <h3>最新文章</h3>
            <ul class="latest-posts">
              <!-- 最新文章在这里动态添加 -->
            </ul>
          </div>
        </div>
      </div>
      <footer>
        <div class="footcontent">
          <div class="footer-wrapper">
            <h4 class="footer-title">Quick Link</h4>
            <ul class="footer-menu footer-2-menu">
              <li><a href="/index">主页</a></li>
              <li><a href="/product">产品</a></li>
              <li><a href="/evaluation">测评</a></li>
              <li><a href="#">资讯</a></li>
              <li><a href="/forum">论坛</a></li>
              <li><a href="#">我的</a></li>
              <li><a href="#">帮助和支持</a></li>
            </ul>
          </div>
          <div class="subscription">
            <div>
              <h4 class="dingyuetit">订阅我们</h4>
              <p></p>
              <p></p>
              <div class="subscription-input-wrapper">
                <input type="email" name="輸入你的郵箱*" required="" placeholder="輸入你的郵箱*" id="comp-jucjyt59input" value=""
                  class="sub">
                <a href="index.html">
                  <button2 class="button2" type="button">現在訂閲</button2>
                </a>
              </div>
              <img class="subcon" src="img/connect.png">
            </div>
            <div></div>
          </div>
          </p>
          <div class="contact-wrapper">
            <div>
              <h4 class="footer-title">联系我们</h4>
              <ul class="footer-link">
                <li>广州工商学院, 三水校区 <br> 广东，中国
                </li>
                <li><a href="/cdn-cgi/l/email-protection" class="__cf_email__"
                    data-cfemail="1e7f7a7377705e7b667f736e727b307d7173">[email&#160;protected]</a>
                </li>
                <li>114- 5141919810</li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
    <div class="copyright">
      <p class="bs">&copy; 2023 by TechCode. Proudly created by Deng Yumin</p>
    </div>
    <script>
      const postId = getPostIdFromUrl(); // 从URL中获取帖子ID

      $(document).ready(function () {
        loadPost(postId);
        loadComments(postId);
        loadLatestPosts();

        $('#comment-text').emojioneArea({
          pickerPosition: 'bottom'
        });

        $('#comment-form').on('submit', function (e) {
          e.preventDefault();
          const text = $('#comment-text').val();
          const parentCommentId = $('#parent-comment-id').val();
          submitComment(postId, text, parentCommentId);
        });

        $('#comments').on('click', '.reply-button', function () {
          const parentCommentId = $(this).data('id');
          const $repliesContainer = $(this).siblings('.replies');

          // 隐藏其他回复表单
          $('.replies #reply-form-container').not($repliesContainer).hide();

          // 设置回复表单的parentCommentId
          $('#parent-comment-id').val(parentCommentId);

          // 将回复表单添加到点击的评论下方
          $repliesContainer.append($('#reply-form-container'));
          $('#reply-form-container').show();
        });

        $('#cancel-reply').on('click', function () {
          $('#parent-comment-id').val('');
          $('#reply-form-container').hide(); // 隐藏回复表单
        });

        $('#reply-form').on('submit', function (e) {
          e.preventDefault();
          const text = $('#reply-text').val();
          const parentCommentId = $('#parent-comment-id').val();
          submitReply(postId, text, parentCommentId);
        });
      });

      function getPostIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
      }

      function loadPost(postId) {
        $.get(`/api/posts/${postId}/data`, function (post) {
          const html = `
            <h2>${post.title}</h2>
            <p class="post-info">作者：${post.author_id} | 发布日期：${post.created_at}</p>
            <p>${post.content}</p>
          `;
          $('#post-content').html(html);
        });
      }

      function loadComments(postId) {
        $.get(`/api/posts/${postId}/comments`, function (comments) {
          console.log(comments);
          const commentTree = buildCommentTree(comments);
          displayComments(commentTree);
        });
      }

      function buildCommentTree(comments) {
        const topLevelComments = comments.filter(c => !c.parent_comment_id);
        const replies = comments.filter(c => c.parent_comment_id);

        topLevelComments.forEach(comment => {
          comment.replies = replies.filter(reply => reply.parent_comment_id === comment.id);
        });

        return topLevelComments;
      }

      function displayComments(comments) {
        let html = '';
        comments.forEach((comment) => {
          html += `
            <div class="comment" data-id="${comment.id}">
              <h3>${comment.author_id}</h3>
              <p>${comment.content}</p>
              <button class="reply-button" data-id="${comment.id}">回复</button>
              <div class="replies">
                ${comment.replies.map((reply) => `
                  <div class="reply" data-id="${reply.id}">
                    <h4>${reply.author_id}</h4>
                    <p>${reply.content}</p>
                  </div>
                `).join('')}
              </div>
            </div>`;
        });
        console.log(html);
        $('#comments').html(html);
      }

      function submitReply(postId, text, parentCommentId) {
        $.post('/api/comments', { postId, text, parentCommentId }, function () {
          $('#reply-text').val('');
          $('#parent-comment-id').val('');
          $('#reply-form-container').hide(); // 隐藏回复表单
          loadComments(postId);
        });
      }

      function submitComment(postId, text, parentCommentId) {
        $.post('/api/comments', { postId, text, parentCommentId }, function () {
          $('#comment-text').val('');
          $('#parent-comment-id').val('');
          loadComments(postId);
        });
      }

      function loadLatestPosts() {
        $.get('/api/latest-posts', function (posts) {
          console.log(posts);
          displayLatestPosts(posts);
        });
      }

      function displayLatestPosts(posts) {
        let html = '';
        posts.forEach((post) => {
          html += `<li><a href="/post?id=${post.id}">${post.title}</a></li>`;
        });
        $('.sidebar ul').html(html);
      }

    </script>
  </body>

</html>